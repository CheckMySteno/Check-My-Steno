<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Advanced Test Analysis Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="robots" content="noindex">
  
  <link rel="preconnect" href="https://firestore.googleapis.com">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    :root{
      --white:#fff; --dark:#1f2937; --muted:#6b7280; --card:#ffffff; --bg:#f8f9fa;
      --ok:#16a34a; --warn:#f59e0b; --bad:#dc2626;
      --shadow: 0 5px 15px rgba(0, 0, 0, .05);
      --border-color: #e9ecef;
      --primary-blue: #4f46e5;
    }
    body.dark {
      --white:#1f2937; --dark:#f9fafb; --muted:#9ca3af; --card:#2c3748; --bg:#111827;
      --shadow:0 4px 12px rgba(0,0,0,.15);
      --border-color: #374151;
    }
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
    body{margin:0;font-family:'Inter',system-ui,Arial,sans-serif;background:var(--bg);color:var(--dark);transition: background-color 0.3s ease, color 0.3s ease;}
    body.modal-open { overflow: hidden; }
    #loader { display: flex; justify-content: center; align-items: center; height: 100vh; }
    .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: var(--primary-blue); animation: spin 1s ease infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .container{max-width:1100px;margin:24px auto;padding:0 16px; display: none;}
    h1{margin:0 0 10px 0;font-size:28px;font-weight:800;letter-spacing:-.02em}
    .sub{color:var(--muted);margin-bottom:20px}
    .header-actions { display: flex; gap: 10px; align-items: center; position: absolute; top: 24px; right: 24px; }
    .header-actions button { background: var(--card); border: 1px solid var(--border-color); color: var(--dark); border-radius: 8px; cursor: pointer; padding: 8px; width: 36px; height: 36px; font-size: 18px; display:flex; justify-content:center; align-items:center; }
    .toolbar{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:20px}
    .pill{background:var(--card); border: 1px solid var(--border-color); border-radius:999px;padding:6px 12px;font-size:12px;color:var(--muted);font-weight:600;}
    .access-pill{background:#dbeafe;color:#1d4ed8; border:none;}
    
    #detailedAnalysisBtn {
        background: linear-gradient(135deg, #8e2de2, #4a00e0);
        color: white;
        border: none;
        cursor: pointer;
        font-weight: 600;
        padding: 6px 12px;
        border-radius: 999px;
        font-size: 12px;
        transition: opacity 0.2s ease;
    }
    #detailedAnalysisBtn:hover { opacity: 0.9; }

    .summary-metrics{display:grid; grid-template-columns:repeat(auto-fit, minmax(150px, 1fr)); gap:16px; margin-bottom: 20px;}
    .summary-item{background:var(--card); border-radius:14px; box-shadow:var(--shadow); padding:15px; text-align:center; font-size:14px; color:var(--dark); border:1px solid var(--border-color);}
    .summary-item strong{display:block;font-size:22px;color:var(--dark); font-weight:700;}
    
    .analysis-section{ background: var(--card); border-radius: 14px; box-shadow: var(--shadow); margin-bottom: 20px; border: 1px solid var(--border-color); }
    .analysis-header{ padding: 12px 16px; background: var(--bg); border-bottom: 1px solid var(--border-color); display:flex; justify-content:space-between; align-items:center; gap: 8px;}
    .analysis-title{ font-size: 18px; font-weight: 700; color: var(--dark); margin: 0; }
    .analysis-content-area{ padding: 16px; }
    .mistake-profile-container { display: grid; grid-template-columns: 180px 1fr; align-items: center; gap: 20px; }
    @media (max-width: 600px) { .mistake-profile-container { grid-template-columns: 1fr; } }
    #mistakeProfileChartContainer { position: relative; max-width: 180px; aspect-ratio: 1; }
    .analysis-list{ list-style: none; padding: 0; margin: 0; border: 1px solid var(--border-color); border-radius: 8px; }
    .analysis-list li{ display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; font-size: 14px; }
    .analysis-list li:nth-child(even){ background-color: var(--bg); }
    .analysis-list .count{ font-weight: 700; color: var(--bad); }
    .analysis-list .empty-state { padding: 20px; text-align: center; color: var(--muted); }

    .chart-container { position: relative; height: 320px; max-width: 900px; margin: 0 auto; background: var(--card); border-radius: 8px; padding: 10px; box-shadow: var(--shadow); }

    #attemptsList { display: flex; flex-direction: column; gap: 12px; }
    .attempt-list-item { background: var(--card); border: 1px solid var(--border-color); border-radius: 12px; padding: 16px; display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 16px; cursor: pointer; transition: background-color 0.2s ease, box-shadow 0.2s ease; }
    .attempt-list-item:hover { background-color: var(--bg); box-shadow: 0 6px 16px rgba(0,0,0,.08); }
    .list-item-main { flex: 1 1 250px; display:flex; align-items:center; gap:12px; }
    .list-item-date { font-weight: 600; font-size: 15px; color: var(--dark); margin-bottom: 4px; }
    .list-item-volume { font-size: 13px; color: var(--muted); }
    .list-item-stats { flex: 2 1 400px; display: flex; gap: 12px; flex-wrap: wrap; }
    .stat-chip { text-align: left; }
    .stat-chip-label { font-size: 12px; color: var(--muted); }
    .stat-chip-value { font-size: 16px; font-weight: 700; color: var(--dark); }
    .stat-chip-value .badge { color:#fff; font-size: 14px; padding: 4px 10px; border-radius: 999px; }
    .badge.green{background:var(--ok)} .badge.orange{background:var(--warn)} .badge.red{background:var(--bad)}
    
    #loadMoreBtn { width: 100%; padding: 12px; margin-top: 20px; font-size: 15px; font-weight: 600; cursor: pointer; border-radius: 8px; border: 1px solid var(--border-color); background: var(--card); color: var(--primary-blue); display: none; }
    #loadMoreBtn:hover { background: var(--bg); }
    #loadMoreBtn:disabled { cursor: not-allowed; color: var(--muted); }

    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(20, 20, 30, 0.9); backdrop-filter: blur(5px); display: none; justify-content: center; align-items: center; z-index: 1000; }
    .modal-content { background: var(--bg); width: 100%; max-width: 600px; border-radius: 14px; display: flex; flex-direction: column; overflow: hidden; max-height: 90%;}
    .modal-header { padding: 12px 20px; background: var(--card); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); }
    .modal-title { font-size: 18px; font-weight: 700; }
    .modal-btn { background: var(--bg); border: 1px solid var(--border-color); padding: 8px 14px; border-radius: 8px; font-weight: 600; cursor: pointer; color: var(--dark); }
    .modal-body { overflow-y: auto; padding: 20px; }
    .modal-footer { padding: 12px 20px; text-align: center; border-top: 1px solid var(--border-color); background: var(--card); }
    
    /* Styles for Welcome Modal Content */
    #welcomeModal .modal-body h3 { color: var(--primary-blue); margin-top: 0; }
    #welcomeModal .modal-body ul { list-style: none; padding-left: 0; }
    #welcomeModal .modal-body li { margin-bottom: 12px; padding-left: 25px; position: relative; }
    #welcomeModal .modal-body li::before { content: 'âœ…'; position: absolute; left: 0; color: var(--ok); }
    #welcomeModal .modal-body hr { border: none; border-top: 1px solid var(--border-color); margin: 20px 0; }
    
    .details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .details-item { background: var(--bg); border: 1px solid var(--border-color); padding: 16px; border-radius: 8px; text-align: center; }
    .details-item-label { font-size: 14px; color: var(--muted); margin-bottom: 8px; }
    .details-item-value { font-size: 28px; font-weight: 700; color: var(--dark); }
    .empty{padding:14px;text-align:center;background:var(--card);border-radius:12px;border:1px dashed var(--border-color)}
    .skeleton-card { animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; background-color: var(--border-color); border-radius: 12px; height: 80px; margin-bottom: 12px; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    
    .achievement-toast { 
        position:fixed; bottom:20px; right:20px; 
        background:linear-gradient(135deg, #6d28d9, #4f46e5); 
        color:white; padding:16px 24px; border-radius:12px; 
        box-shadow:0 10px 25px rgba(0,0,0,.2); z-index:2000; 
        transform:translateY(200%); opacity:0; 
        transition: all 0.5s cubic-bezier(0.25, 1, 0.5, 1); 
    }
    .achievement-toast.show { transform:translateY(0); opacity:1; }
    .achievement-toast h4 { margin:0 0 4px 0; font-size:16px; font-weight:700; }
    .achievement-toast p { margin:0; font-size:14px; }
</style>
</head>
<body>
  <div id="loader"><div class="spinner"></div></div>
  
  <div class="container" style="display: block; visibility: hidden;">
    <div class="header-actions">
      <button id="themeToggleBtn" title="Toggle Theme">ðŸŒ™</button>
    </div>
    <h1>Test Analysis Dashboard</h1>
    <div class="sub">View your progress and analyze performance metrics from your practice sessions.</div>
    <div class="toolbar">
      <span id="ac-pill" class="pill access-pill"></span>
      <span id="count-pill" class="pill">0 attempts</span>
      <span id="avg-accuracy-pill" class="pill">Avg. Accuracy: â€”</span>
      <button id="detailedAnalysisBtn">ðŸ”¬ Detailed Analysis</button>
    </div>
    
    <div class="summary-metrics">
      <div class="summary-item"><span>Total Attempts</span><strong id="totalAttempts">0</strong></div>
      <div class="summary-item"><span>Best Accuracy</span><strong id="bestAccuracy">â€”%</strong></div>
      <div class="summary-item"><span>Best WPM</span><strong id="bestWPM">â€”</strong></div>
      <div class="summary-item"><span>Avg. WPM</span><strong id="averageWPM">â€”</strong></div>
    </div>

    <div class="analysis-section" id="mistakeAnalysisSection" style="display:none;">
      <div class="analysis-header"><h3 class="analysis-title">Mistake Profile</h3></div>
      <div class="analysis-content-area">
        <div class="mistake-profile-container">
            <div id="mistakeProfileChartContainer"><canvas id="mistakeProfileChart"></canvas></div>
            <ul id="mistakeProfileList" class="analysis-list">
                <div class="empty-state">No mistake data to analyze.</div>
            </ul>
        </div>
      </div>
    </div>

    <div class="chart-container" style="margin-top:20px;">
        <canvas id="progressChart"></canvas>
    </div>
    
    <div id="attemptsListSkeleton" style="margin-top: 20px;">
        <div class="skeleton-card"></div>
        <div class="skeleton-card"></div>
        <div class="skeleton-card"></div>
    </div>

    <div id="attemptsList" style="display: none; margin-top: 20px;"></div>
    <button id="loadMoreBtn">Load More</button>
    <div id="emptyState" class="empty" style="display:none; margin-top: 20px;">No attempts found for this access code.</div>
  </div>

  <!-- Welcome Modal -->
  <div id="welcomeModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">ðŸ‘‹ Welcome to Your Analysis Dashboard!</div>
      </div>
      <div class="modal-body">
        <h3>Your Journey to Mastery Starts Here</h3>
        <p>This dashboard is your personal command center for tracking and improving your skills. Here's what you can do:</p>
        <ul>
          <li><strong>Track Your Progress:</strong> Visualize your Accuracy and WPM growth over time with interactive charts.</li>
          <li><strong>View Key Stats:</strong> Instantly see your best scores and overall averages at a glance.</li>
          <li><strong>Analyze Mistakes:</strong> Get a breakdown of your common mistake types (if available in your data).</li>
        </ul>
        <hr>
        <h4>âœ¨ Coming Soon: Deep Dive Analysis!</h4>
        <p>Get ready for the "Detailed Analysis" feature, a powerful new tool that will allow you to go word-for-word through your transcripts. You'll see exactly where you made substitutions, omissions, and other errors, complete with AI-powered suggestions for improvement!</p>
      </div>
      <div class="modal-footer">
         <button id="welcome-close-btn" class="modal-btn" style="width: 50%; padding: 12px; font-size: 16px; background: var(--primary-blue); color: white; border: none;">Get Started</button>
      </div>
    </div>
  </div>

  <!-- Details Modal -->
  <div id="detailsModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <div id="modal-title" class="modal-title">Attempt Details</div>
        <button id="modal-close-btn" class="modal-btn">Close</button>
      </div>
      <div id="modal-body-content" class="modal-body"></div>
    </div>
  </div>
  
  <div id="achievementToast" class="achievement-toast"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, query, orderBy, getDocs, limit, startAfter } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // --- Utility Functions (defined upfront) ---
    function escapeHtml(s=""){ return s.toString().replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    // --- State Variables ---
    let chartInstance, mistakeChartInstance = null;
    let allAttemptsData = [];
    let lastVisibleDoc = null;
    let isLoadingMore = false;
    let allDataLoaded = false;
    const ATTEMPTS_PER_PAGE = 10;
    
    if (typeof Chart === 'undefined') { console.error('Chart.js library is not loaded.'); }

    // --- Firebase & Auth ---
    const firebaseConfig = { apiKey: "AIzaSyDPkUWIrsibI-hzKJ8ljhvawdJ9Nq4-cpE", authDomain: "checkmysteno.firebaseapp.com", projectId: "checkmysteno", storageBucket: "checkmystenofirebasestorage.app", messagingSenderId: "719325115943", appId: "1:719325115943:web:0dd50a67978816d42a8002" };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    const accessCode = localStorage.getItem("currentAccessCode");
    if (!accessCode) { 
        alert("No access code found. Please log in first."); 
        window.location.href = "index.html"; 
    } else { 
        document.getElementById("ac-pill").textContent = `Access Code: ${accessCode}`; 
    }

    // --- Charting ---
    function renderProgressChart(data) {
        const ctx = document.getElementById('progressChart')?.getContext('2d');
        if (!ctx) return;

        const labels = data.map(d => new Date(d.timestamp.seconds * 1000).toLocaleDateString("en-IN"));
        const accuracyData = data.map(d => d.accuracy);
        const wpmData = data.map(d => d.wpm);

        if (chartInstance) {
            chartInstance.data.labels = labels;
            chartInstance.data.datasets[0].data = accuracyData;
            chartInstance.data.datasets[1].data = wpmData;
            chartInstance.update();
        } else {
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Accuracy (%)', data: accuracyData, borderColor: '#4f46e5', backgroundColor: 'rgba(79, 70, 229, 0.1)', yAxisID: 'yAccuracy', tension: 0.1 },
                        { label: 'WPM', data: wpmData, borderColor: '#16a34a', backgroundColor: 'rgba(22, 163, 74, 0.1)', yAxisID: 'yWPM', tension: 0.1 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        yAccuracy: { type: 'linear', display: true, position: 'left', min: 0, title: { display: true, text: 'Accuracy (%)' } },
                        yWPM: { type: 'linear', display: true, position: 'right', min: 0, title: { display: true, text: 'WPM' }, grid: { drawOnChartArea: false } }
                    }
                }
            });
        }
    }
    
    function renderMistakeProfileChart(profileData) {
        const ctx = document.getElementById('mistakeProfileChart')?.getContext('2d');
        if (!ctx) return;
        if (mistakeChartInstance) mistakeChartInstance.destroy();

        const labels = Object.keys(profileData);
        const data = Object.values(profileData);

        if (labels.length === 0) return;

        document.getElementById('mistakeAnalysisSection').style.display = 'block';

        mistakeChartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: { labels, datasets: [{ data, backgroundColor: ['#dc2626', '#f59e0b', '#facc15', '#84cc16', '#22c55e', '#14b8a6'], borderColor: 'var(--card)', borderWidth: 4 }] },
            options: { responsive: true, maintainAspectRatio: true, cutout: '60%', plugins: { legend: { display: false } } }
        });
    }

    // --- UI Update Functions ---
    function showNotification(title, message) {
        const toast = document.getElementById('achievementToast');
        if (!toast) return;
        toast.innerHTML = `<h4>${title}</h4><p>${message}</p>`;
        toast.classList.add('show');
        setTimeout(() => {
            toast.classList.remove('show');
        }, 4000);
    }

    function updateSummaryMetrics(data) {
        document.getElementById('count-pill').textContent = `${data.length} attempts shown`;
        document.getElementById('totalAttempts').textContent = data.length;
        if (data.length === 0) return;

        const bestAcc = data.reduce((max, p) => p.accuracy > max ? p.accuracy : max, 0);
        const bestWPM = data.reduce((max, p) => p.wpm > max ? p.wpm : max, 0);
        const avgWPM = data.reduce((sum, p) => sum + p.wpm, 0) / data.length;
        const avgAcc = data.reduce((sum, p) => sum + p.accuracy, 0) / data.length;

        document.getElementById('bestAccuracy').textContent = `${bestAcc.toFixed(2)}%`;
        document.getElementById('bestWPM').textContent = Math.round(bestWPM);
        document.getElementById('averageWPM').textContent = Math.round(avgWPM);
        document.getElementById('avg-accuracy-pill').textContent = `Avg. Accuracy: ${avgAcc.toFixed(2)}%`;
    }

    function updateMistakeAnalysis(data) {
        const mistakeProfile = {};
        data.forEach(attempt => {
            if (attempt.detailedMistakes && Array.isArray(attempt.detailedMistakes)) {
                attempt.detailedMistakes.forEach(m => {
                    const type = m.type.charAt(0).toUpperCase() + m.type.slice(1);
                    mistakeProfile[type] = (mistakeProfile[type] || 0) + 1;
                });
            }
        });

        renderMistakeProfileChart(mistakeProfile);

        const profileListEl = document.getElementById('mistakeProfileList');
        const sortedProfile = Object.entries(mistakeProfile).sort((a, b) => b[1] - a[1]);
        if (sortedProfile.length > 0) {
            profileListEl.innerHTML = sortedProfile.map(([type, count]) => `<li><span>${type}</span> <span class="count">${count}</span></li>`).join('');
        }
    }
    
    function appendAttemptsToDOM(attempts) {
        const listEl = document.getElementById("attemptsList");
        const fragment = document.createDocumentFragment();

        attempts.forEach(attempt => {
            const badgeClass = attempt.accuracy >= 90 ? "green" : attempt.accuracy >= 70 ? "orange" : "red";
            const listItem = document.createElement("div");
            listItem.className = "attempt-list-item";
            listItem.innerHTML = `
                <div class="list-item-main">
                    <div>
                        <div class="list-item-date">${new Date(attempt.timestamp.seconds * 1000).toLocaleString("en-IN")}</div>
                        <div class="list-item-volume">Transcript: ${escapeHtml(attempt.transcript)}</div>
                    </div>
                </div>
                <div class="list-item-stats">
                    <div class="stat-chip"><div class="stat-chip-label">Accuracy</div><div class="stat-chip-value"><span class="badge ${badgeClass}">${attempt.accuracy.toFixed(2)}%</span></div></div>
                    <div class="stat-chip"><div class="stat-chip-label">WPM</div><div class="stat-chip-value">${Math.round(attempt.wpm)}</div></div>
                    <div class="stat-chip"><div class="stat-chip-label">Mistakes</div><div class="stat-chip-value">${attempt.fullMistakes + attempt.halfMistakes}</div></div>
                </div>`;
            listItem.addEventListener('click', () => openDetailsModal(attempt));
            fragment.appendChild(listItem);
        });
        listEl.appendChild(fragment);
    }

    // --- Modal Logic ---
    function openDetailsModal(attempt) {
        document.getElementById('modal-title').textContent = `Summary for ${escapeHtml(attempt.transcript)}`;
        document.getElementById('modal-body-content').innerHTML = `
            <div class="details-grid">
                <div class="details-item"><div class="details-item-label">Accuracy</div><div class="details-item-value">${attempt.accuracy.toFixed(2)}%</div></div>
                <div class="details-item"><div class="details-item-label">WPM</div><div class="details-item-value">${Math.round(attempt.wpm)}</div></div>
                <div class="details-item"><div class="details-item-label">Full Mistakes</div><div class="details-item-value">${attempt.fullMistakes}</div></div>
                <div class="details-item"><div class="details-item-label">Half Mistakes</div><div class="details-item-value">${attempt.halfMistakes}</div></div>
            </div>
            <p style="text-align:center; color: var(--muted); margin-top: 20px;">Date: ${new Date(attempt.timestamp.seconds * 1000).toLocaleString("en-IN")}</p>
        `;
        document.getElementById('detailsModal').style.display = 'flex';
    }

    // --- Main Data Fetching ---
    async function fetchMoreAttempts() {
        if (isLoadingMore || allDataLoaded) return;
        isLoadingMore = true;
        const loadMoreBtn = document.getElementById('loadMoreBtn');
        loadMoreBtn.disabled = true;
        loadMoreBtn.textContent = 'Loading...';

        const attemptsCol = collection(db, "testAnalysis", accessCode, "attempts");
        let q;
        if (lastVisibleDoc) {
            q = query(attemptsCol, orderBy("timestamp", "desc"), startAfter(lastVisibleDoc), limit(ATTEMPTS_PER_PAGE));
        } else {
            q = query(attemptsCol, orderBy("timestamp", "desc"), limit(ATTEMPTS_PER_PAGE));
        }

        const snap = await getDocs(q);

        if (snap.empty) {
            allDataLoaded = true;
            loadMoreBtn.style.display = 'none';
            if (allAttemptsData.length === 0) {
                document.getElementById('emptyState').style.display = 'block';
                document.getElementById('attemptsListSkeleton').style.display = 'none';
            }
        } else {
            lastVisibleDoc = snap.docs[snap.docs.length - 1];
            const newAttempts = snap.docs.map(doc => ({
                id: doc.id,
                ...doc.data(),
                accuracy: parseFloat(String(doc.data().accuracy || "0").replace("%","")),
                wpm: Number(doc.data().typingSpeed || doc.data().strokesPerMinute / 5 || 0),
                fullMistakes: Number(doc.data().fullMistakes || 0),
                halfMistakes: Number(doc.data().halfMistakes || 0),
                transcript: doc.data().transcript || doc.data().transId || "Unknown"
            }));
            
            allAttemptsData.push(...newAttempts);
            appendAttemptsToDOM(newAttempts);
            
            updateSummaryMetrics(allAttemptsData);
            updateMistakeAnalysis(allAttemptsData);
            renderProgressChart(allAttemptsData.slice().reverse()); 

            document.getElementById('attemptsList').style.display = 'flex';
            document.getElementById('attemptsListSkeleton').style.display = 'none';
            if (snap.docs.length < ATTEMPTS_PER_PAGE) {
                allDataLoaded = true;
                loadMoreBtn.style.display = 'none';
            } else {
                 loadMoreBtn.style.display = 'block';
            }
        }

        isLoadingMore = false;
        loadMoreBtn.disabled = false;
        loadMoreBtn.textContent = 'Load More';
    }

    // --- Event Listeners & Initial Load ---
    function loadTheme() {
        const isDark = localStorage.getItem(`stenotheme_${accessCode}`) === 'dark';
        document.body.classList.toggle('dark', isDark);
        document.getElementById('themeToggleBtn').textContent = isDark ? 'â˜€ï¸' : 'ðŸŒ™';
    }

    document.getElementById('loadMoreBtn').addEventListener('click', fetchMoreAttempts);
    document.getElementById('modal-close-btn').addEventListener('click', () => document.getElementById('detailsModal').style.display = 'none');
    document.getElementById('themeToggleBtn').addEventListener('click', () => {
        const isDark = document.body.classList.toggle('dark');
        localStorage.setItem(`stenotheme_${accessCode}`, isDark ? 'dark' : 'light');
        document.getElementById('themeToggleBtn').textContent = isDark ? 'â˜€ï¸' : 'ðŸŒ™';
    });
    
    document.getElementById('detailedAnalysisBtn').addEventListener('click', () => {
        showNotification('Coming Soon!', 'This feature is in development and will be available in a future update.');
    });

    // NEW: WELCOME MODAL LOGIC
    document.getElementById('welcome-close-btn').addEventListener('click', () => {
        document.getElementById('welcomeModal').style.display = 'none';
        // Use a key specific to the access code
        localStorage.setItem(`dashboard_visited_${accessCode}`, 'true');
    });

    async function initializeDashboard() {
        document.getElementById('loader').style.display = 'none';
        document.querySelector('.container').style.visibility = 'visible';
        loadTheme();
        await fetchMoreAttempts();
        
        // Check for first visit after everything is loaded
        if (!localStorage.getItem(`dashboard_visited_${accessCode}`)) {
            document.getElementById('welcomeModal').style.display = 'flex';
        }
    }
    
    initializeDashboard();
  </script>
</body>

</html>
